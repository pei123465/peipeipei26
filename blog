AWS ALBのインバウンドIP制限と
CloudFront + WAF IPSet を使った解決方法について

==================================================

■ 本記事でわかること

・ALBでインバウンドIP制限を行う際の課題
・セキュリティグループのルール数上限の制約
・CloudFront + WAF を使ったIP制御の考え方
・CloudFrontのVPCオリジンを使ったセキュアな構成
・セキュリティグループとWAF IPSetの上限の違い

■ 用語の簡単な説明

【CloudFrontとは】

CloudFrontは、AWSが提供するCDN（Content Delivery Network）サービスです。

一般的にはコンテンツ配信で利用されますが、
WAFと組み合わせることで
Webアプリケーションの入口としても利用できます。

【VPCオリジンとは】

VPCオリジンは、
CloudFrontからVPC内のリソースへ
プライベート接続するためのオリジン設定です。

インターネットを経由せずに
VPC内のALBへ通信させることができ、
セキュリティを高めることができます。

【ALBとは】

ALB（Application Load Balancer）は、
HTTP / HTTPS通信を対象としたロードバランサーです。

L7でのルーティングが可能で、
多くのWebシステムで利用されています。

【セキュリティグループとは】

セキュリティグループは、
EC2やALBなどに適用する仮想ファイアウォールです。

インバウンド / アウトバウンドの通信制御ができますが、
ルール数には上限があります。

■ セキュリティグループとWAF IPSetの上限について

【セキュリティグループのルール数上限】

セキュリティグループでは、
インバウンド / アウトバウンドそれぞれに
ルール数の上限が設けられています。

一般的な制約としては、

・1セキュリティグループあたり
インバウンドルール、アウトバウンドルールともに
数十件程度が上限
・IPアドレス1つにつき1ルールを消費する
・大量のIPを許可するとすぐに上限に到達する

といった特徴があります。

クォータ引き上げは可能ですが、
IP制御用途として継続的に使う前提の設計には
向いていないと感じました。

【WAF IPSetの上限】

一方、WAFのIPSetは
IPアドレス管理を前提に設計された仕組みです。

特徴としては、

・1つのIPSetに
数千〜1万単位のIPアドレスを登録可能
・ルール数を消費せずにIPをまとめて管理できる
・IPの追加・削除を前提とした運用がしやすい

IP数が多い場合や、
将来的に増減する可能性がある場合は、
セキュリティグループよりも適しています。

■ AWS ALBのインバウンドIP制限でハマった話

AWSでWebシステムを構成する際、
ALBに対して特定のIPのみ許可したい、
という要件はよくあります。

一般的には、
ALBに紐づくセキュリティグループの
インバウンドルールでIP制限を行います。

しかし、今回以下のような問題に直面しました。

・許可したいIPアドレスの数が多い
・セキュリティグループのルール数上限に達した

このままでは運用が難しいため、
構成を見直すことにしました。

■ 解決策：CloudFront + WAFでIP制御する

対応として、ALBの前段にCloudFrontを配置しました。

IP制限については、
WAFのIPSetを利用して制御します。

この構成にすることで、

・IP数が増えても設計を変えずに対応できる
・セキュリティグループは最小構成にできる
・CloudFrontを経由しない通信を遮断できる

という構成になります。

■ 構成のポイント

【1. CloudFrontをALBの前段に配置】

エンドユーザーからのアクセスは、
すべてCloudFrontで受け付けます。

ALBへ直接アクセスさせないことで、
入口をCloudFront + WAFに集約しています。

【2. WAFのIPSetでIP制御】

CloudFrontにWAFを関連付け、
WAFのIPSetで許可IPを管理します。

IP数が増えても、
セキュリティグループの制限を気にする必要がありません。

【3. CloudFrontのVPCオリジンを使用】

CloudFrontのオリジンには、
VPCオリジンを使用し、
ALBを指定しています。

【4. ALBはインターナルで作成】

ALBはインターナルALBとして作成し、
インターネットから直接到達できない構成としています。

これにより、
CloudFront + WAFを経由しないアクセス経路を
物理的に排除できます。

■ まとめ

・セキュリティグループは
少数IPの制御向き
・大量IPの管理には向いていない
・WAF IPSetは
大量IP管理を前提とした仕組み

IP数が多いALBのIP制限では、
CloudFront + WAF + インターナルALB構成が
現実的な選択肢になります。

==================================================

次にやるなら
・セキュリティグループ最小構成例
・WAF IPSetの更新運用（手動 / 自動）

を足すと、設計意図がさらに明確になる。
